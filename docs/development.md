# 开发指南

## 安装机器人
> 由于`CKYU`已经停止服务，机器人已经`兼容地`迁移到了`mirai`框架，以下将提供该框架的相应说明。

+ 安装`mirai`与相关组件
+ 安装`mirai-cqhttp`并进行相应配置
+ 安装`Python 3.7+`
+ 安装依赖项
```
    pip install -r requirements.txt
```
+ 安装思源宋体(Source Han Serif)
+ 根据Nonebot中的说明修改CQHttp与NoneBot间的相关配置
+ (可选)修改配置`config.py`
+ 运行机器人
```
    py -3 bot.py
```

## 数据库相关
+ 数据库分为**全局数据库**和**局部数据库**两类，全局数据库需要拥有一个联萌的关联账号，局部数据库会根据群信息自动生成。

+ 机器人提供一个命令行下的数据库解析工具`dbconfig.py`。
```
	使用方法: dbconfig.py [-h] [-e] [-d] [-n] [-y]

	可选参数:
	  -h, --help          显示该帮助信息
	  -e, --encrypt       加密数据库
	  -d, --decrypt       解密数据库
	  -n, --new_database  生成数据库
	  -y, --yes           直接确认更改

	注意: 每次运行均需要输入数据库的密码
	
	建议: 在一次执行中只选择 -e -d -n 中的一个参数
```

> 此处的数据库不是关系型数据库，只采用了一些简单的JSON文件，并对其进行了加密。

> 局部数据库是跟群组相关的，不同的机器人同时访问同一个群组的数据库会导致数据异常。

## 超级管理员相关
超级管理员相当于整个控制系统的核心部分, 可以登录/退出登录机器人关联的账号, 当机器人关联账号处于登出状态时, 所有功能无法使用, 其语法如下:
+ 登录机器人关联账户
```
    login/登录
```

+ 登出机器人关联账户
```
    logout/登出/退出登录
```

+ 写入数据库
```
	save/存档
```

> 超级管理员最多允许有`1`个，建议将管理员设定为运行程序的用户，每次运行机器人程序时，超级管理员需要输入密码，密码错误将无法运行程序。

> 数据库只有写入指令，没有显式的读取指令。

+ 设定游戏频率
```
	setfreq/游戏频率 设定的频率(x小时/题)
```

+ 手动开启42点
```
	manual42/手动42点
```

> 42点只要开始，在结束前就不能再次触发。

+ 重置小黑屋
```
	resetroom/重置小黑屋
```

## 更精细的权限控制
+ 为了使机器人在不同的群内使用不同的功能，可以新建一个权限控制文件`policy.json`，内部的结构需要写成这样:
```json
	{
		"plugin_name": {
			"groups": [ 1, 2, 3 ],
			"users": [ 4, 5, 6 ]
		}, 
		"another_plugin_name": {
			"groups": [ 1, 2, 3 ],
			"users": [ 4, 5, 6 ]			
		}
	}
```

> `plugin_name`为`./mswar/plugins/*.py`中的文件名，`groups`里面写群号，`users`里面写用户QQ号，采用白名单策略，即用户需要在`groups`中出现的群组里面，也需要在`users`中出现的用户里面，才可以触发`plugin_name`中包含的**所有**命令。在配置文件中**请勿包含注释**。

> 此功能较为复杂，**不建议**使用，或者仅建议在小范围内使用，项目本身不提供配置文件，需要自行编写。

## 协议
+ 本项目基于`AGPL 3.0`开源, 详细的协议见[这里](http://www.gnu.org/licenses/agpl-3.0.html)。

## 其它
+ 欢迎提出意见与贡献代码。